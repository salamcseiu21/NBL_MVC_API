@using NBL.BLL
@model NBL.Models.ViewModels.Deliveries.ViewDeliveryModel

@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_UserLayoutPage.cshtml";
    UserManager userManager = new UserManager();
    var date = DateTime.Now.Date.ToString("dd-MMMM-yyyy");
    var invoicedBy = userManager.GetUserInformationByUserId(Model.Invoice.InvoiceByUserId);
    var aClient = Model.Client;
    var invoice = Model.Invoice;
}


<section class="content">
    <div class="row text-center text-danger">
        @if (TempData["Error"] != null)
        {
            @TempData["Error"]
        }
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <h3 class="text-center text-green headingStyle">Delivery</h3>
            <br />
            <div class="row" style="border: 1px dotted; padding: 10px; font-size: 18px">

                <div class="col-md-6" style="margin:0;padding:0;">
                    <section>
                        <img src="~/@aClient.ClientImage" height="120" width="100" style="float:left;margin-right:20px" title="@aClient.ClientName" />
                        <address>
                            @Html.Raw(aClient.GetMailingAddress())
                        </address>

                    </section>
                </div>
                <div class="col-md-6" style="margin:0;padding:0;">
                    <section>
                        Invoice Ref: @invoice.InvoiceRef<br />
                        Invoice Date : @invoice.InvoiceDateTime.ToString("D")<br />
                        Invoiced By :<i>@invoicedBy.EmployeeName</i>

                    </section>
                </div>
            </div>
      
      

        </div>
    </div>
    <br/>
    <div class="row">
        <div class="col-md-4 col-md-offset-4" style="border: 1px solid;">
            @using (Html.BeginForm("SaveScannedBarcodeToTextFile", "Delivery", FormMethod.Post, new { id = "scanProductBarcodeForm" }))
            {
                <div class="form-horizontal">
                    <h3 class="text-center">Scan Product</h3>
                    <div id="message" style="display:none;font-weight:bold;font-size:20px" class="text-center">
                    </div>
                    <div class="form-group">
                        <label for="ProductCode" class="control-label col-md-3">Product Code</label>
                        <input type="hidden" id="InvoiceId" name="InvoiceId" value="@Model.Invoice.InvoiceId" />
                        <div class="col-md-9">
                                
                            <input type="text" name="ProductCode" id="ProductCode" class="form-control" placeholder="Always keep pointer here.." autofocus onchange="SaveScannedBarcodeToTextFile(this)"/>
                        </div>

                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-md-3"></div>
                            <div class="col-md-9">
                                <div class="btn toolbar">
                                    <button type="button" value="@Model.Invoice.InvoiceId" class="btn btn-success" onclick="Delivery(this)"> Delivery</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <br/>
    <div class="row">
        <div class="col-md-10 col-md-offset-1" style="border: 1px dotted;padding: 5px">
            <table id="table_deliverable_product_List" class="display" style="border:1px solid black">
                <caption class="text-center text-green" style="font-weight:bolder;font-size:20px">Product List</caption>

                <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Product Code</th>
                </tr>
                </thead>
               
                <tfoot>
                <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Product Code</th>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    @Html.Partial("_ModalDeliveryPartialPage")
</section>
@section Scripts
{
    
<script src="~/Areas/Manager/Scripts/loadAllDeliverableOrderedProducts.js"></script>
    <script>
        $(function () {

            $("#DeliveryDate").datepicker({ dateFormat: 'dd-MM-yy' });
            $("#table_deliverable_product_List").DataTable();
        });
    </script>

    <script>

        function SaveDeliveryInfo(id) {

            if (confirm("Are you sure to Save  this delivery info?")) {

                $("#saveDeliveryInfoForm").submit();
            } else {
                return false;// if it's a link to prevent post
            }

            return false;// if it's a link to prevent post


        }
    </script>


    <script type="text/javascript">
        // -----Prevent to enter max qty more than invoce------------
        $(document).ready(function () {

            $('.product_delivered_qty').on('keydown keyup', function (e) {
                var qtyId = "#invoced_qty_" + this.id;
                var invoiceQty = parseInt($(qtyId).val());
                if ($(this).val() > invoiceQty
                        && e.keyCode !== 46 // keycode for delete
                        && e.keyCode !== 8 // keycode for backspace
                ) {
                    e.preventDefault();
                    $(this).val(invoiceQty);
                }
            });
        });
    </script>
    
    <script>
        function SaveScannedBarcodeToTextFile(btnClicked) {
            var $form = $(btnClicked).parents('form');
            $.ajax({
                type: "POST",
                url: RootUrl + 'manager/delivery/SaveScannedBarcodeToTextFile',
                data: $form.serialize(),
                error: function (xhr, status, error) {
                    alert(error);
                },
                success: function (response) {
                    var result = response.Message;
                    //alert("Saved Successfully");
                    $('#message').html(response).fadeIn('slow');
                    $('#message').html(result).fadeIn('slow'); //also show a success message
                    $('#message').delay(700).fadeOut('slow');
                    loadAllDeliverableOrderedProducts();
                    $('#scanProductBarcodeForm').trigger("reset");
                }
            });
        }
    </script>

    <script>

        function Delivery(invoiceId) {

            $.ajax({
                type: "POST",
                url: "@Url.Action("ViewInvoiceIdOrderDetails", "Delivery", new { area = "Manager" })",
                data: { invoiceId: invoiceId.value },
                success: function (response) {
                    $('#modalBody').html(response);
                    $('#showDeliveryModal').modal('show');
                }
            });
        }

    </script>
    
    
<script>
        window.onload = function () {
            loadAllDeliverableOrderedProducts();
        };
</script>
}
