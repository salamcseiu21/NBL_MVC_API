@model NBL.Models.ViewModels.TransferProducts.ViewTripModel
@{
    ViewBag.Title = "Delivery";
    Layout = "~/Views/Shared/_UserLayoutPage.cshtml";
}

<section class="content">
    <p class="text-center text-green" style="font-weight:bolder;font-size:20px">Deliverable Trip Details</p>

    <div class="row" style="padding: 10px">


        <div class="col-md-6 col-md-offset-3" style="border: 1px solid;">
            
            <div class="form-horizontal">
                <h3 class="text-center">Scan Product</h3>
                @if (TempData["QuantityNotSame"] != null)
                {
                    <p class="text-danger">@TempData["QuantityNotSame"]</p>
                }
                <div id="message" style="display:none;font-weight:bold;font-size:20px" class="text-center">
                </div>
                <div class="form-group">
                    @Html.LabelFor(m => m.ProductCode, new { @class = "control-label col-md-2" })
                    <input type="hidden" id="TripId" name="TripId" value="@Model.TripId" />
                    <div class="col-md-10">
                        @Html.TextBoxFor(m => m.ProductCode, new { @class = "form-control", placeholder = "Always keep pointer here..!!", autofocus = "", onchange = "SaveScannedBarcodeToTextFile(this)" })
                        @Html.ValidationMessageFor(m => m.ProductCode, "", new { @class = "text-danger" })
                    </div>

                </div>
                <div class="form-group">
                    <div class="col-md-offset-2 col-md-10">
                        <div class="btn-toolbar">
                            <button type="button" id="btnSaveDispatchInfo" value="@Model.TripId" class="btn btn-success" onclick="SaveDispatchInfo(this)"> Dispatch</button>
                            <a class="btn btn-danger" href="~/factory">Cancel</a>
                        </div>

                    </div>
                </div>

                <div class="form-group">

                    <div class="row" style="padding: 10px">
                        <div class="col-md-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="control-label">Requisition Qty :</label>

                                </div>
                                <div class="col-md-6">
                                    <label class="control-label" id="lbl_requisition_qty"></label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="row">
                                <div class="col-md-6">

                                    <label class="control-label">Scanned Qty :</label>
                                </div>
                                <div class="col-md-6">
                                    <label class="control-label" id="lbl_scanned_qty"></label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="row">
                                <div class="col-md-6">

                                    <label class="control-label">Scan Status :</label>
                                </div>
                                <div class="col-md-6">
                                    <div id="div_status" style="font-weight: bold;padding: 5px">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <div class="row" style="padding: 15px; border: 1px solid;margin: 10px">
        <div class="col-md-6">
            <div id="required_Trip_products"></div>
        </div>
        <div class="col-md-6">
            <div id="scanned_Trip_Products"></div>
        </div>
        <hr />
    </div>
</section>

@section Scripts
{

    <script>
        function SaveScannedBarcodeToTextFile(event) {
            // var $form = $(btnClicked).parents('form');
            var code = $("#ProductCode").val();
            var tripId = $("#TripId").val();
            $.ajax({
                type: "POST",
                url: RootUrl + 'factory/delivery/SaveScannedBarcodeToTextFile',
                data: { barcode: code, tripId: tripId },
                error: function (xhr, status, error) {
                    alert(error);
                },
                success: function (response) {
                    var result = response.Message;
                    //alert("Saved Successfully");
                    $('#message').html(response).fadeIn('slow');
                    $('#message').html(result).fadeIn('slow'); //also show a success message
                    $('#message').delay(700).fadeOut('slow');
                    loadScannedProducts();
                    $('#ProductCode').val("");
                }
            });
        }
    </script>
    
    <script>
       
        function SaveDispatchInfo(id) {

            if (confirm("Are you confirm to Dispatch?")) {
                var tripId = $("#TripId").val();
                $.ajax({
                    type: "Post",
                    url: RootUrl + 'factory/delivery/SaveDispatchInformation',
                    data: { tripId: tripId },
                    error: function (xhr, status, error) {
                        alert(error);
                    },
                    success: function (response) {
                        loadAllDeliverableProducts();
                        loadScannedProducts();
                    }
                });
            } else {
                return false;// if it's a link to prevent post
            }

            return false;// if it's a link to prevent post


        }
    </script>

    <script>
        $(document).ready(function () {
            loadAllDeliverableProducts();
            loadScannedProducts();
        });

        function loadAllDeliverableProducts() {
            var tripId = $("#TripId").val();
            var json = { tripId: tripId };
            
            $.ajax({
                type: 'POST',
                url: RootUrl + "factory/Delivery/LoadDeliverableProduct",
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(json),
                success: function (data) {
                    $("#required_Trip_products").html(data);
                  
                }
            });
        }

        function loadScannedProducts() {
            var tripId = $("#TripId").val();
            var json = { tripId: tripId };
            $.ajax({
                type: 'POST',
                url: RootUrl + "factory/Delivery/LoadScannecdProduct",
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(json),
                success: function (data) {
                    $("#scanned_Trip_Products").html(data);
                    var requisitionQty = parseInt($("#total_requisition_qty").val());
                    var scannedQty = parseInt($("#total_Scanned_qty").val());
                    $("#lbl_requisition_qty").text(requisitionQty);
                    $("#lbl_scanned_qty").text(scannedQty);
                    if (requisitionQty !== scannedQty) {
                        $("#btnSaveDispatchInfo").prop('disabled', true);
                        $("#div_status").html("<p style='color:red'>Not Complete</p>");
                    } else {
                        $("#btnSaveDispatchInfo").removeAttr('disabled');
                        $("#div_status").html("<p style='color:green'>Complete</p>");
                    }
                }
            });
        }

    </script>
    
}
